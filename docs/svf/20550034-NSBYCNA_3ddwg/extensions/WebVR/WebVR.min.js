AutodeskNamespace("Autodesk.Viewing.Extensions.WebVR"),Autodesk.Viewing.Extensions.WebVR.StereoRenderContext=function(a,b,c,d){function e(a,b,c,d,e){a.matrixWorld.decompose(e.position,e.quaternion,e.scale),d&&e.position.set(0,0,0),e.translateOnAxis(c?m:n,q),e.projectionMatrix.elements=c?b.leftProjectionMatrix:b.rightProjectionMatrix}var a,f,g,h,i,j,k=a.getEyeParameters("left"),l=a.getEyeParameters("right"),m=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.PerspectiveCamera,p=new THREE.PerspectiveCamera,q=10*a.modelScaleFactor,r=null;this.init=function(c,e,j){f=new avp.RenderContext,g=c;var o=1.5*window.devicePixelRatio;h=2*a.getEyeParameters("left").renderWidth/o,i=a.getEyeParameters("right").renderHeight/o,this.settings=f.settings,f.init(g,h,i),m.fromArray(k.offset),n.fromArray(l.offset),r=new VRFrameData,b.worldup&&1==b.worldup.z&&(d.webVR_orbitModel=!1)},this.modeFusion=function(c){var d=new THREE.Vector3(0,0,1);d.applyQuaternion((new THREE.Quaternion).fromArray(c.orientation)).multiplyScalar(2.1*q),b.position.set(d.x,d.y,d.z),b.lookAt(a.target),b.up.set(0,1,0)},this.modeWalkthrough=function(a){a.orientation&&0!=a.orientation[1]&&b.quaternion.fromArray(a.orientation),a.position&&0!=a.position[0]&&b.position.fromArray(a.position).multiplyScalar(q),b.worldup&&1==b.worldup.z&&(b.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2),b.quaternion.multiply((new THREE.Quaternion).fromArray(a.orientation)),a.position&&0!=a.position[0]&&b.position.set(b.position.x,-b.position.z,b.position.y));var c=new THREE.Vector3(0,0,-1);c.applyQuaternion(b.quaternion),b.target=b.position.clone().add(c.clone().multiplyScalar(10))},this.updateCamera=function(){if(a&&a._isPresenting&&(a.depthNear=b.near,a.depthFar=b.far,a.getFrameData(r),j=r.pose,j.orientation))return d.webVR_orbitModel?this.modeFusion(j):this.modeWalkthrough(j),b.updateMatrixWorld(),b.dirty=!0,e(b,r,!0,!1,o),e(b,r,!1,!1,p),c&&(c.camera=b.clone(),c.camera.position.set(0,0,0),e(b,r,!0,!0,c.cameraL),e(b,r,!1,!0,c.cameraR)),{L:o,R:p,C:b}},this.beginScene=function(a,c,d,e){f.beginScene(a,b,d,e)},this.renderScenePart=function(a,b,d,e,j){var k=h/2;g.setViewport(0,0,k,i),f.setCamera(o),f.renderScenePart(a,!0,!1,!1,!1),g.setViewport(k,0,k,i),f.setCamera(p),f.renderScenePart(a,!0,!1,!1,!1),c&&(g.setViewport(0,0,k,i),f.setCamera(c.cameraL),f.renderScenePart(c.scene,!0,!1,!1,!1),g.setViewport(k,0,k,i),f.setCamera(c.cameraR),f.renderScenePart(c.scene,!0,!1,!1,!1)),g.setViewport(0,0,h,i)},this.sceneDirty=function(a,b){f.sceneDirty(a,b)},this.endScene=function(){f.endScene()},this.clearAllOverlays=function(){},this.renderOverlays=function(a){},this.composeFinalFrame=function(b,c){f.composeFinalFrame(!0,c),a._isPresenting&&a.submitFrame()},this.cleanup=function(){f.cleanup()},this.setSize=function(a,b,c){h=a,i=b,f.setSize(h,i,c)},this.getMaxAnisotropy=function(){return f.getMaxAnisotropy()},this.hasMRT=function(){return f.hasMRT()},this.initPostPipeline=function(a,b,c){f.initPostPipeline(!1,!1,!1)},this.setClearColors=function(a,b){f.setClearColors(a,b)},this.setAOOptions=function(a,b){f.setAOOptions(a,b)},this.getAORadius=function(){return f.getAORadius()},this.getAOIntensity=function(){return f.getAOIntensity()},this.setTonemapExposureBias=function(a){f.setTonemapExposureBias(a)},this.getExposureBias=function(){return f.getExposureBias()},this.setTonemapMethod=function(a){f.setTonemapMethod(a)},this.getToneMapMethod=function(){return f.getToneMapMethod()},this.toggleTwoSided=function(a){f.toggleTwoSided(a)},this.enter2DMode=function(a){f.enter2DMode(a)},this.getAOEnabled=function(){return!1},this.idAtPixel=function(a,b){return 0},this.overlayUpdate=function(a){f.overlayUpdate(a)},this.rolloverObjectViewport=function(a,b){},this.screenCapture=function(){return console.warn("Screen capture not implemented by stereo render context"),null},this.setUnitScale=function(a){f.setUnitScale(a)},this.getUnitScale=function(){return f.getUnitScale()},this.getColorTarget=function(){return null}},AutodeskNamespace("Autodesk.Viewing.Extensions.WebVR"),Autodesk.Viewing.Extensions.WebVR.VRExtension=function(a,b){Autodesk.Viewing.Extension.call(this,a,b)},Autodesk.Viewing.Extensions.WebVR.VRExtension.populateDefaultOptions=function(a){a.experimental.push("--webVR_orbitModel"),a.experimental.push("--webVR_cursor"),a.experimental.push("--webVR_menu")},Autodesk.Viewing.Extensions.WebVR.VRExtension.prototype=Object.create(Autodesk.Viewing.Extension.prototype),Autodesk.Viewing.Extensions.WebVR.VRExtension.prototype.constructor=Autodesk.Viewing.Extensions.WebVR.VRExtension,Autodesk.Viewing.Extensions.WebVR.VRExtension.prototype.load=function(){var a=this,b=null;return avp.injectCSS("extensions/WebVR/WebVR.min.css"),avp.loadDependency("VRFrameData","webvr-polyfill.min.js",function(){navigator.getVRDisplays().then(function(c){if(c.length>0&&(b=c[0],b.capabilities.canPresent)){var d=a.viewer,e=d.getToolbar(!0),f=Autodesk.Viewing.UI;return a.tool=new Autodesk.Viewing.Extensions.WebVR.VRTool(d,a,b),d.toolController.registerTool(a.tool),a.createUI(e),a.onToolChanged=function(b){var c="vr"===b.toolName&&b.active,d=c?f.Button.State.ACTIVE:f.Button.State.INACTIVE;a.vrToolButton&&a.vrToolButton.setState(d)},void d.addEventListener(Autodesk.Viewing.TOOL_CHANGE_EVENT,a.onToolChanged)}avp.logger.warn("Attempted to load WebVR extension, but WebVR is not supported.")})}),!0},Autodesk.Viewing.Extensions.WebVR.VRExtension.prototype.createUI=function(a){var b=this,c=this.viewer,d=Autodesk.Viewing.UI,e=a.getControl(Autodesk.Viewing.TOOLBAR.NAVTOOLSID);this.vrToolButton=new d.Button("toolbar-vrTool"),this.vrToolButton.setToolTip("Enable VR mode"),this.vrToolButton.setIcon("adsk-icon-webvr"),this.vrToolButton.onClick=function(a){var e=b.vrToolButton.getState();e===d.Button.State.INACTIVE?c.setActiveNavigationTool("vr"):e===d.Button.State.ACTIVE&&c.setActiveNavigationTool()};var f=e.getControl("toolbar-cameraSubmenuTool");f?e.addControl(this.vrToolButton,{index:e.indexOf(f.getId())}):e.addControl(this.vrToolButton)},Autodesk.Viewing.Extensions.WebVR.VRExtension.prototype.unload=function(){var a=this.viewer;this.onToolChanged&&(a.removeEventListener(Autodesk.Viewing.TOOL_CHANGE_EVENT,this.onToolChanged),this.onToolChanged=void 0);var b=a.getToolbar(!1);return b&&this.vrToolButton&&b.getControl(Autodesk.Viewing.TOOLBAR.NAVTOOLSID).removeControl(this.vrToolButton.getId()),this.vrToolButton=null,this.tool&&(a.toolController.deregisterTool(this.tool),this.tool=null),!0},Autodesk.Viewing.theExtensionManager.registerExtension("Autodesk.Viewing.WebVR",Autodesk.Viewing.Extensions.WebVR.VRExtension),Autodesk.Viewing.Extensions.WebVR.VRTool=function(a,b,c){var d,e,f=a.canvas,g=a.navigation,h=g.getCamera(),i={webVR_cursor:avp.isExperimentalFlagEnabled("webVR_cursor",b.options),webVR_menu:avp.isExperimentalFlagEnabled("webVR_menu",b.options),webVR_orbitModel:avp.isExperimentalFlagEnabled("webVR_orbitModel",b.options)},j=["vr"],k=!1,l=!1;this.activate=function(b){k=!0,a.impl.toggleGroundShadow(!1),a.impl.toggleGroundReflection(!1),g.toPerspective(),g.setVerticalFov(75,!0),g.setRequestFitToView(!0);var j=a.model.getBoundingBox().size();if(c.target=a.model.getBoundingBox().center(),g.setPivotPoint(c.target,!0,!0),g.setView(h.position,c.target),g.setCameraUpVector(new THREE.Vector3(0,1,0)),c.modelScaleFactor=Math.max(Math.min(Math.min(j.x,j.y),j.z)/10,1e-4),c._isPresenting=av.isMobileDevice(),c.requestPresent([{source:f}]).then(function(){a.impl.setLmvDisplay(c),c._isPresenting=!0}),c.resetPose(),av.isMobileDevice()){m(!1),a.setScreenMode(Autodesk.Viewing.ScreenMode.kFullScreen),f.addEventListener("dblclick",function(){k&&a.setActiveNavigationTool()})}(i.webVR_cursor||i.webVR_menu)&&(e=this.initHUD()),d=new Autodesk.Viewing.Extensions.WebVR.StereoRenderContext(c,h,e,i),a.impl.setUserRenderContext(d)},this.initHUD=function(){var b=new THREE.Scene,d=h.clone();if(i.webVR_menu){var e=new Autodesk.Viewing.Extensions.WebVR.Menu(c.modelScaleFactor);e.init(b)}if(i.webVR_cursor){var g=h.worldup&&1==h.worldup.z,j=new Autodesk.Viewing.Extensions.WebVR.Cursor(a.impl,a.autocam,c.modelScaleFactor,g);j.init(b),f.addEventListener("click",j.onClick)}return{scene:b,camera:d,cameraL:d.clone(),cameraR:d.clone(),menu:e,cursor:j,IPD:1.2}},this.update=function(b){if(!c)return!0;l&&!c.isPresenting&&k&&a.setActiveNavigationTool(),l=c.isPresenting;var f=d.updateCamera();return!e||(i.webVR_cursor&&e.cursor.update(f.C,e),i.webVR_menu&&e.menu.update(e.camera),!0)},this.deactivate=function(b){c&&(c.isPresenting&&c.exitPresent(),c._isPresenting=!1),k=!1,m(!0),a.impl.setUserRenderContext(null),a.setScreenMode(Autodesk.Viewing.ScreenMode.kNormal),a.resize(a.canvas.clientWidth,a.canvas.clientHeight),a.autocam.resetHome(),e&&i.webVR_cursor&&f.removeEventListener("click",e.cursor.onClick)};var m=function(b){a.displayViewCubeUI(b),a.displayViewCube(b&&!av.isMobileDevice());var c=document.getElementsByClassName("adsk-toolbar");c.length>0&&""!==c[0]&&(c[0].style.display=b?"block":"none")};this.isActive=function(){return k},this.getNames=function(){return j},this.getName=function(){return j[0]}},Autodesk.Viewing.Extensions.WebVR.Menu=function(a){var b,c,d,e,f=16777215;this.init=function(a){function d(a,b,c){return new THREE.Mesh(new THREE.PlaneBufferGeometry(b,1),new THREE.MeshBasicMaterial({map:g.loadTexture(e(a)),color:f,side:THREE.DoubleSide,depthTest:!1,transparent:!0,opacity:c}))}if(!b){var e=Autodesk.Viewing.Private.getResourceUrl,g=THREE.ImageUtils;g.crossOrigin="anonymous";var h=["back.png","zoomin.png","zoomout.png","next.png"];b=new THREE.Object3D,c=new THREE.Object3D;var i=new THREE.Object3D;i.position.set(0,-12,-14),i.rotateX(-.6);for(var j=0;j<h.length;j++){var k=d("res/webvr/"+h[j],2,1);k.position.set(2*(j-h.length/2),0,.1),k.scale.set(.94,.94,.1),i.add(k)}var l=d("res/webvr/bg.png",48,.1);i.add(l),c.add(i),b.add(c),b.visible=!0,a.add(b)}},this.onVisible=function(a){c.rotation.y=a.rotation._z,d=-b.quaternion.y},this.update=function(a){var c=a.quaternion.clone().inverse();b.quaternion.copy(c);var g=b.visible;b.visible=b.quaternion.x>.26&&b.quaternion.x<.4,!g&&b.visible&&this.onVisible(a),e>=0&&e<4&&b.children[0].children[0].children[e].material.color.setHex(f),(e=Math.floor(4.54*(d+b.quaternion.y+.14)*4))>=0&&e<4&&b.children[0].children[0].children[e].material.color.setHex(11184895)},this.onClick=function(){}},Autodesk.Viewing.Extensions.WebVR.Cursor=function(a,b,c,d){var e,f;this.init=function(a){e=new THREE.Object3D,e.scale.set(.25,.25,1),e.add(new THREE.Mesh(new THREE.RingGeometry(.6,1,32,32),new THREE.MeshBasicMaterial({color:11141154,depthTest:!1,side:THREE.DoubleSide}))),a.add(e)},this.update=function(b,d){var g;f=a.hitTestViewport(new THREE.Vector3,!1),f?(e.children[0].material.color.setHex(8874),g=f.intersectPoint.clone().sub(b.position).length()):(e.children[0].material.color.setHex(11141154),g=.5*(b.far-b.near));var h=new THREE.Matrix4;h.extractRotation(d.camera.matrixWorld);var i=new THREE.Vector3(0,0,-1);i=h.multiplyVector3(i),i.multiplyScalar(g),e.scale.set(c,c,c),e.position.copy(i),e.lookAt(d.camera.position)},this.onClick=function(){if(f){var a=f.intersectPoint;f.face.normal;d?a.z+=5:a.y+=5;var c=b.getCurrentView();c.position.copy(a),c.center.set(a.x+1e-6,a.y,a.z),c.pivot.set(a.x,a.y,a.z),b.goToView(c)}}};