!function(){var a=Autodesk.Viewing,b=a.Extensions,c=a.Private,d=a.UI;b.MemoryManager=function(b,c){a.Extension.call(this,b,c)},b.MemoryManager.prototype=Object.create(a.Extension.prototype),b.MemoryManager.prototype.constructor=b.MemoryManager,b.MemoryManager.prototype.createUI=function(){var a=this.viewer,c=this;this.panel=new b.MemoryManagerPanel(a),this.memMgrBtn=new d.Button("toolbar-memMgrBtn"),this.memMgrBtn.setToolTip("Memory Manager"),this.memMgrBtn.setIcon("adsk-icon-mem-mgr"),this.memMgrBtn.onClick=function(a){var b="none"===c.panel.container.style.display;c.panel.setVisible(b)},a.modelTools.addControl(this.memMgrBtn)},b.MemoryManager.prototype.close=function(){this.panel.setVisible(!1,!0)},b.MemoryManager.prototype.load=function(){function b(){d.removeEventListener(a.TOOLBAR_CREATED_EVENT,b),e.createUI()}c.injectCSS("extensions/MemoryManager/MemoryManagerUI.min.css");var d=this.viewer,e=this;return d.modelTools?e.createUI():d.addEventListener(a.TOOLBAR_CREATED_EVENT,b),!0},b.MemoryManager.prototype.unload=function(){var a=this.viewer;return this.panel&&(this.panel.setVisible(!1),this.panel.uninitialize(),this.panel=null),a.modelTools.removeControl(this.memMgrBtn.getId()),this.memMgrBtn=null,!0},a.theExtensionManager.registerExtension("Autodesk.Viewing.MemoryManager",b.MemoryManager)}(),AutodeskNamespace("Autodesk.Viewing.Extensions"),function(){function a(a){function c(){var a=q.viewer.model;if(a){var b=q.viewer.prefs,d=a.getFragmentList().pagingProxy;if(d){var e=d.options;e.hasOwnProperty("limit")&&(e.limit=b.get("memorymanager.memorySize")),e.debug.hasOwnProperty("maxPageOutSize")&&(e.debug.maxPageOutSize=b.get("memorymanager.maxPageOutSize")),e.debug.hasOwnProperty("occlusionThreshold")&&(e.debug.occlusionThreshold=b.get("memorymanager.keepIdPixels"),q.viewer.impl.renderer().settings.occlusionid=e.debug.occlusionThreshold>0),e.debug.hasOwnProperty("occlusionTestThreshold")&&(e.debug.occlusionTestThreshold=b.get("memorymanager.occludePixels")),e.debug.hasOwnProperty("startOcclusionTestingPackCount")&&(e.debug.startOcclusionTestingPackCount=b.get("memorymanager.startOcclusionTesting")),e.debug.hasOwnProperty("testPackfileCount")&&(e.debug.testPackfileCount=b.get("memorymanager.occlusionPackCount")),e.debug.hasOwnProperty("useOcclusionInstancing")&&(e.debug.useOcclusionInstancing=b.get("memorymanager.occludeInstancing")),e.debug.hasOwnProperty("boxProxyMaxCount")&&(e.debug.boxProxyMaxCount=b.get("memorymanager.boxProxyMaxCount")),e.debug.hasOwnProperty("boxProxyMinScreen")&&(e.debug.boxProxyMinScreen=b.get("memorymanager.boxProxyMinScreen")),e.debug.hasOwnProperty("automaticRefresh")&&(e.debug.automaticRefresh=b.get("memorymanager.autoRefresh"))}q.viewer.removeEventListener(Autodesk.Viewing.MODEL_ROOT_LOADED_EVENT,c)}}function j(a,b,c){var d=document.createElement("div");return q.addControl(a,d,{caption:b,insertAtIndex:c}),d.sliderRow.cells[1].style.width=r,d.style.marginLeft=s,d.style.marginRight=s,d}function l(a){var b=q.getControl(a);return b.sliderRow.cells[1].style.width=r,b}function m(){q.model&&q.impl.invalidate(!0,!0,!0)}function n(a){if(-1===a)return-1;if(q.viewer.model){var b,c=q.viewer.model.getFragmentList();return c&&c.pagingProxy&&"function"==typeof c.pagingProxy.pfOrder&&(b=c.pagingProxy.pfOrder()),b?b[a]:a}return-1}function o(){if(q.viewer.model){var a=q.viewer.model.getFragmentList();a.showPF=-1,a.showBox=!1}}function p(){if(i=Number(q.showPFSlider.value),q.viewer.model){var a=q.viewer.model.getFragmentList(),b=a.pagingProxy;q.pfCheckbox.getValue()?a.showPF=n(i):a.showPF=i,b&&(b.options.debug.boxProxyMaxCount=Number(q.numBoxesSlider.value),b.options.debug.boxProxyMinScreen=Number(q.screenBoxesSlider.value),q.refreshPanel())}}this.viewer=a,a.prefs.load(e),a.addEventListener(Autodesk.Viewing.MODEL_ROOT_LOADED_EVENT,c);var q=this,r="200px",s="7px";d.SettingsPanel.call(this,a.container,"MemoryManagePanel"+a.id,"Memory Manager",{width:380,heightAdjustment:155}),this.addVisibilityListener(function(a){a?(q.refreshPanel(),q.resizeToContent()):k>0&&(clearTimeout(k),k=0)}),this.container.dockRight=!0,this.addTab(f,"Memory",{className:"mem-mgr-memory"}),this.addTab(g,"Occlusion",{className:"mem-mgr-occlusion"}),this.addTab(h,"Debug",{className:"mem-mgr-debug"}),this.refreshDiv=document.createElement("div"),this.refreshDiv.className="mem-mgr-reload",this.refreshDiv.textContent="Refresh",this.addEventListener(this.refreshDiv,"touchstart",b.touchStartToClick),this.addEventListener(this.refreshDiv,"click",function(){q.viewer.model&&(o(),q.bboxCheckbox.setValue(!1),q.viewer.dispatchEvent({type:b.LOAD_MISSING_GEOMETRY,delay:!1,debug:{unloadPackFiles:!!q.upfCheckbox.getValue()}}),q.showPFSlider.setValue(-1),p(),q.refreshPanel())},!1),this.container.appendChild(this.refreshDiv),this.onDemandLoading=j(f,"On Demand Loading",-1),this.packFileCount=j(f,"Pack File Count",-1),this.geomMemorySize=j(f,"Geom Memory Size",-1),this.memUsedSize=j(f,"Memory Used",-1),this.lastPageOut=j(f,"Last Page Out",-1);var t=a.prefs;this.autoCheckbox=l(this.addCheckbox(h,"Auto Refresh",t.get("memorymanager.autoRefresh"),function(a){if(t.set("memorymanager.autoRefresh",a),q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy;b&&(b.options.debug.automaticRefresh=a)}})),this.upfCheckbox=l(this.addCheckbox(h,"Unload Packfiles",t.get("memorymanager.unloadPackfiles"),function(a){t.set("memorymanager.unloadPackfiles",a)})),this.occtSlider=l(this.addSlider(g,"Keep Id Pixels",0,4096,t.get("memorymanager.keepIdPixels"),function(a){if(t.set("memorymanager.keepIdPixels",Number(q.occtSlider.stepperElement.value)),q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy,c=Number(q.occtSlider.stepperElement.value);b&&(b.options.debug.occlusionThreshold=c),q.viewer.impl.renderer().settings.occlusionid=c>0}})),this.occtSlider.sliderElement.step=this.occtSlider.stepperElement.step=1,this.poctSlider=l(this.addSlider(g,"Pack Occluded Pixels",0,4096,t.get("memorymanager.occludePixels"),function(a){if(t.set("memorymanager.occludePixels",Number(q.poctSlider.stepperElement.value)),q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy,c=Number(q.poctSlider.stepperElement.value);b&&(b.options.debug.occlusionTestThreshold=c)}})),this.poctSlider.sliderElement.step=this.poctSlider.stepperElement.step=1,this.socpSlider=l(this.addSlider(g,"Start Occlusion",0,4096,t.get("memorymanager.startOcclusionTesting"),function(a){if(t.set("memorymanager.startOcclusionTesting",Number(q.socpSlider.stepperElement.value)),q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy,c=Number(q.socpSlider.stepperElement.value);b&&(b.options.debug.startOcclusionTestingPackCount=c)}})),this.socpSlider.sliderElement.step=this.socpSlider.stepperElement.step=1,this.tstcSlider=l(this.addSlider(g,"Occlusion Pack Count",1,4,t.get("memorymanager.occlusionPackCount"),function(a){if(t.set("memorymanager.occlusionPackCount",Number(q.tstcSlider.stepperElement.value)),q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy,c=Number(q.tstcSlider.stepperElement.value);b&&(b.options.debug.testPackfileCount=c)}})),this.tstcSlider.sliderElement.step=this.tstcSlider.stepperElement.step=1,this.occInstCheckbox=l(this.addCheckbox(g,"Occlusion Instancing",t.get("memorymanager.occludeInstancing"),function(a){if(t.set("memorymanager.occludeInstancing",a),q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy;b&&(b.options.debug.useOcclusionInstancing=a)}})),this.occlusionCulledCount=j(f,"Occlusion Culled Count",-1),this.pfSlider=l(this.addSlider(f,"Memory Limit MB",10,2050,t.get("memorymanager.memorySize"),function(a){if(t.set("memorymanager.memorySize",Number(q.pfSlider.stepperElement.value)),q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy;b&&(b.options.limit=Number(q.pfSlider.stepperElement.value))}})),this.pfSlider.sliderElement.step=this.pfSlider.stepperElement.step=10,this.maxPSlider=l(this.addSlider(f,"Max Page Out Size",10,2050,t.get("memorymanager.maxPageOutSize"),function(a){if(t.set("memorymanager.maxPageOutSize",Number(q.maxPSlider.stepperElement.value)),q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy;b&&(b.options.debug.maxPageOutSize=Number(q.maxPSlider.stepperElement.value))}})),this.maxPSlider.sliderElement.step=this.maxPSlider.stepperElement.step=10,this.pfCheckbox=l(this.addCheckbox(h,"PF by importance",!0,function(){p(),m()})),this.pfCheckbox.checkElement.disabled=!0,this.showPFSlider=l(this.addSlider(h,"Show single PF",-1,1500,-1,function(a){if(q.viewer.model){var b=q.viewer.model.getFragmentList().pagingProxy;b&&(b.options.debug.automaticRefresh=!1)}p(),m()})),this.showPFSlider.sliderElement.step=this.showPFSlider.stepperElement.step=1,this.showPFSlider.sliderElement.disabled=this.showPFSlider.stepperElement.disabled=!0,this.numBoxesSlider=l(this.addSlider(h,"Proxy boxes",0,1e5,t.get("memorymanager.boxProxyMaxCount"),function(a){t.set("memorymanager.boxProxyMaxCount",Number(q.numBoxesSlider.value)),p(),m()})),this.numBoxesSlider.sliderElement.step=this.numBoxesSlider.stepperElement.step=1,this.screenBoxesSlider=l(this.addSlider(h,"Proxy screen area",0,4,t.get("memorymanager.boxProxyMinScreen"),function(a){t.set("memorymanager.boxProxyMinScreen",Number(q.screenBoxesSlider.value)),p(),m()})),this.screenBoxesSlider.sliderElement.step=this.screenBoxesSlider.stepperElement.step=.1,this.bboxCheckbox=l(this.addCheckbox(h,"Debug: bounding boxes",!1,function(a){q.viewer.model&&(q.viewer.model.getFragmentList().showBox=!!a),m()})),this.bboxCheckbox.checkElement.disabled=!0,this.pfStrategy=j(h,"Pack File Displayed",-1),this.refreshPanel(),this.selectTab(f)}var b=Autodesk.Viewing,c=b.Extensions,d=(b.Private,b.UI),e={"memorymanager.unloadPackfiles":!1,"memorymanager.sblIterator":!1,"memorymanager.autoRefresh":!1,"memorymanager.keepIdPixels":1,"memorymanager.occludePixels":1,"memorymanager.startOcclusionTesting":8,"memorymanager.occlusionPackCount":4,"memorymanager.occludeInstancing":!0,"memorymanager.memorySize":50,"memorymanager.maxPageOutSize":50,"memorymanager.boxProxyMaxCount":0,"memorymanager.boxProxyMinScreen":.4},f="memory",g="occlusion",h="debug",i=-1,j="0",k=0;a.prototype=Object.create(d.SettingsPanel.prototype),a.prototype.constructor=a,a.prototype.refreshPanel=function(a){function c(){if(this.viewer.model){var a,b=this.viewer.model.getFragmentList();return b&&b.pagingProxy&&"function"==typeof b.pagingProxy.pfOrder&&(a=b.pagingProxy.getNumVisiblePFs()),a}return-1}0!==k&&(clearTimeout(k),k=0),k=setTimeout(function(a){k=0,a.isVisible()&&a.refreshPanel(!0)},1e3,this);var d="Unknown",e="#ff0000",f="Unknown",g="Unknown",h="Unknown",l="Unknown",m="Unknown",n="-1 / default",o=1500,p=this.viewer.model;if(p){var q=p.getMemoryInfo(),r=-1,s=-1;j=c.call(this);var t=p.getFragmentList();if(t){d=t.onDemandLoadingEnabled()?"On":"Off",t.onDemandLoadingEnabled()&&(e=""),t.pagingProxy&&(this.bboxCheckbox.setValue(!!t.showBox),this.occInstCheckbox.setValue(!!t.pagingProxy.options.debug.useOcclusionInstancing),this.autoCheckbox.setValue(!!t.pagingProxy.options.debug.automaticRefresh),a||(q&&this.pfSlider.setValue(q.limit),t.pagingProxy.options.debug.maxPageOutSize&&this.maxPSlider.setValue(t.pagingProxy.options.debug.maxPageOutSize),t.pagingProxy.options.debug.occlusionThreshold&&this.occtSlider.setValue(t.pagingProxy.options.debug.occlusionThreshold),t.pagingProxy.options.debug.occlusionTestThreshold&&this.poctSlider.setValue(t.pagingProxy.options.debug.occlusionTestThreshold),t.pagingProxy.options.debug.startOcclusionTestingPackCount&&this.socpSlider.setValue(t.pagingProxy.options.debug.startOcclusionTestingPackCount),t.pagingProxy.options.debug.testPackfileCount&&this.tstcSlider.setValue(t.pagingProxy.options.debug.testPackfileCount)),t.pagingProxy.hasOwnProperty("totalGeomSize")&&(g=t.pagingProxy.totalGeomSize.toFixed(3)+" / limit "+q.effectiveLimit.toFixed(3)),q&&(h=q.loaded.toFixed(3)),t.pagingProxy.hasOwnProperty("loadedPacks")&&(r=Object.keys(t.pagingProxy.loadedPacks).length),t.pagingProxy.hasOwnProperty("packsPagedOut")&&(s=t.pagingProxy.packsPagedOut),t.pagingProxy.hasOwnProperty("lastPageOut")&&(l=t.pagingProxy.lastPageOut.toFixed(3)),t.pagingProxy.hasOwnProperty("occlusionCulledCount")&&(m=t.pagingProxy.occlusionCulledCount.toFixed(0)));var u="all";if(-1!==t.showPF){var v=parseInt(j);-1===i?u="all":(u=t.showPF,v>=0&&(t.pagingProxy.hasOwnProperty("loadedPacks")&&!t.pagingProxy.loadedPacks[t.showPF]&&(u+=" (not loaded)"),i>=v&&(u+=" (fully culled)")))}n=u.toString()}if(p.is2d())f="File is 2D";else{var w=p.getData();w&&(f=w.geompacks.length.toString(),o=f-1),j>=0&&(f+=" / "+j+" visible"),r>=0&&(h+=" / "+r+" loaded"),s>=0&&(l+=" / "+s+" packs paged out")}}this.onDemandLoading.setAttribute("data-i18n",d),this.onDemandLoading.textContent=b.i18n.translate(d),this.onDemandLoading.style.color=e,this.packFileCount.setAttribute("data-i18n",f),this.packFileCount.textContent=b.i18n.translate(f),this.geomMemorySize.setAttribute("data-i18n",g),this.geomMemorySize.textContent=b.i18n.translate(g),this.memUsedSize.setAttribute("data-i18n",h),this.memUsedSize.textContent=b.i18n.translate(h),this.pfStrategy.setAttribute("data-i18n",n),this.pfStrategy.textContent=b.i18n.translate(n),this.lastPageOut.setAttribute("data-i18n",l),this.lastPageOut.textContent=b.i18n.translate(l),this.occlusionCulledCount.setAttribute("data-i18n",m),this.occlusionCulledCount.textContent=b.i18n.translate(m),this.showPFSlider.sliderElement.max=o,this.showPFSlider.stepperElement.max=o},c.MemoryManagerPanel=a}();