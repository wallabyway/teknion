!function(){"use strict";function a(a){this.viewer=a,this.mappingPromise=null,this.filter={seedURN:!0,objectSet:!0,viewport:!0,tags:!0,renderOptions:!1,cutplanes:!0}}function b(a){for(var b={},c=[],d=a.length,e=0,f=0;f<d;f++){var g=a[f];1!==b[g]&&(b[g]=1,c[e++]=g)}return c}var c=AutodeskNamespace("Autodesk.Viewing.Extensions.Comments"),d=Autodesk.Viewing.Private,e=a.prototype;e.destroy=function(){this.viewer=null},e.createCommentObj=function(a){var b=this.viewer.getState(this.filter);return this.injectInfo(b,a),b},e.injectInfo=function(a,b){a.body=b.message||"",a.status="open",a.jsonVersion="2.0",a.inputSource="Web",a.type="geometry";var c=this.viewer.model.getDocumentNode();if(c&&(c=c.findParentGeom2Dor3D(),a.layoutName=c.data.guid,a.layoutIndex=c.data.order),b.point3d){var d=b.point3d;d instanceof THREE.Vector3&&(d=d.toArray()),this.pushTag(a,{name:"nodeOffset",value:d})}},e.isCommentForCurrentSheet=function(a){var b=this.viewer.model.getDocumentNode();return!b||(b=b.findParentGeom2Dor3D(),b.data.guid===a.layoutName)},e.getManifestNode=function(a){var b=this.viewer.model.getDocumentNode();if(b){return b.getRootNode().findByGuid(a.layoutName)}return null},e.pushTag=function(a,b){Array.isArray(a.tags)||(a.tags=[]),a.tags.push(b)},e.getTag=function(a,b){var c=a.tags;if(c&&Array.isArray(c))for(var d=0,e=c.length;d<e;++d)if(c[d].name===b)return c[d];return null},e.getTagValue=function(a,b,c){var d=this.getTag(a,b);return d?d.value:c||null},e.exportCommentObj=function(a){var b=this;return new Promise(function(c){b.applyGlobalOffset(a),b.getMappingPromise().then(function(d){b.mapObjectSetLmvToExternal(a,d,function(a){c(a)})})})},e.importCommentObj=function(a){var b={};for(var c in this.filter)this.filter.hasOwnProperty(c)&&a.hasOwnProperty(c)&&(b[c]=a[c]);var d=JSON.parse(JSON.stringify(b)),e=this;return new Promise(function(a){e.getMappingPromise().then(function(b){e.mapObjectSetExternalToLmv(d,b),e.removeGlobalOffset(d),a(d)})})},e.applyGlobalOffset=function(a){var b=this.viewer.model.getData().globalOffset;if(b){this.applyOffsetToCamera(a.viewport,b);var c=this.getTag(a,"nodeOffset");return c&&this.applyOffset(c.value,b),!0}return!1},e.removeGlobalOffset=function(a){var b=this.viewer.model.getData().globalOffset;if(b){var c={x:-b.x,y:-b.y,z:-b.z};this.applyOffsetToCamera(a.viewport,c);var d=this.getTag(a,"nodeOffset");return d&&this.applyOffset(d.value,c),!0}return!1},e.applyOffsetToCamera=function(a,b){a&&b&&(this.applyOffset(a.eye,b),this.applyOffset(a.target,b),this.applyOffset(a.pivotPoint,b))},e.applyOffset=function(a,b){if(a){var c=Number(a[0])+b.x,d=Number(a[1])+b.y,e=Number(a[2])+b.z;a[0]="string"==typeof a[0]?c.toString():c,a[1]="string"==typeof a[1]?d.toString():d,a[2]="string"==typeof a[2]?e.toString():e}},e.mapObjectSetLmvToExternal=function(a,c,d){c||d(a),this.viewer.model.is2d()&&d(a);var e=this.getObjectSetElementWithIdType(a.objectSet,"lmv"),f=[].concat(e.id).concat(e.hidden).concat(e.isolated);b(f),this.viewer.model.getBulkProperties(f,["externalId"],function(b){var c={};b.forEach(function(a){c[a.dbId]=a.externalId});var f=JSON.parse(JSON.stringify(e));f.idType="external";var g=function(a){return c[a]};f.id=f.id.map(g),f.hidden=f.hidden.map(g),f.isolated=f.isolated.map(g),a.objectSet.push(f),d(a)},function(){d(a)})},e.mapObjectSetExternalToLmv=function(a,b){if(b){var c=a.objectSet;if(!this.getObjectSetElementWithIdType(c,"lmv")){var d=this.getObjectSetElementWithIdType(c,"external");if(d){var e=function(a){return b[a]},f=JSON.parse(JSON.stringify(d));f.id=f.id.map(e),f.isolated=f.isolated.map(e),f.hidden=f.hidden.map(e),f.idType="lmv",c.unshift(f)}}}},e.getObjectSetElementWithIdType=function(a,b){if(!a||!Array.isArray(a))return null;for(var c=0,d=a.length;c<d;++c)if(a[c].idType===b)return a[c];return null},e.getMappingPromise=function(){if(!this.mappingPromise){var a=this;this.mappingPromise=new Promise(function(b){a.viewer.model.getExternalIdMapping(function(a){d.logger.log("[Autodesk.Comment]Successfully fetched external id mapping."),b(a)},function(){d.logger.error("[Autodesk.Comment]Failed to fetch the external id mapping."),b(null)})})}return this.mappingPromise},c.CommentFactory=a}(),function(){"use strict";function a(a,b,c){this.viewer=a,this.cache=c,this.PATH_STORAGE=null,this.fakeRequest=null,this.init(b)}function b(a,b,c,d,e,f){if(a.fakeRequest)return a.fakeRequest.createRequest(b,c,e,f);var g=a.getToken(),h=new XMLHttpRequest;return h.open(b,c,!0),d&&h.setRequestHeader("Content-Type",d),h.setRequestHeader("Access-Control-Allow-Origin","*"),h.setRequestHeader("Authorization","Bearer "+g),h.onload=e.onLoad,h.onerror=e.onError,h.ontimeout=e.onTimeout,h}function c(a,b,c){return{onLoad:function(d){200==d.currentTarget.status?a(c?d.currentTarget.response:d.currentTarget.responseText):b(d.currentTarget)},onError:function(a){b(a.currentTarget)},onTimeout:function(a){b(a.currentTarget)}}}function d(a,b){b&&b.forEach(function(b){a.setRequestHeader(b.name,b.value)})}function e(a){return window.btoa?window.btoa(a):window.Base64.encode(a)}var f=AutodeskNamespace("Autodesk.Viewing.Extensions.Comments"),g=(Autodesk.Viewing.Private,a.prototype);f.ENV_TABLE={Local:{COMMENT:"https://developer-dev.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-dev.api.autodesk.com/oss/v1/"},Development:{COMMENT:"https://developer-dev.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-dev.api.autodesk.com/oss/v1/"},Staging:{COMMENT:"https://developer-stg.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-stg.api.autodesk.com/oss/v1/"},Production:{COMMENT:"https://developer.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer.api.autodesk.com/oss/v1/"},AutodeskDevelopment:{COMMENT:"https://developer-dev.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-dev.api.autodesk.com/oss/v1/"},AutodeskStaging:{COMMENT:"https://developer-stg.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-stg.api.autodesk.com/oss/v1/"},AutodeskProduction:{COMMENT:"https://developer.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer.api.autodesk.com/oss/v1/"}},g.init=function(a){a=a||{},this.env=Autodesk.Viewing.Private.env,a.fakeServer&&(this.fakeRequest=new f.FakeRequest(a)),this.token=a.token3leg;var b=f.ENV_TABLE[this.env];this.COMMENT_SERVICE_URL=b.COMMENT,this.OBJECT_STORAGE_SERVICE_URL=b.OBJECT_STORAGE;var c=a.urn;if(c)this.setPathStorage(c);else{var d=this.viewer,e=this,g=function(){var a=d.model.getDocumentNode();if(a){var b=a.urn(!0);e.setPathStorage(b)}};d.model?g():d.addEventListener(av.GEOMETRY_LOADED_EVENT,function a(){d.removeEventListener(av.GEOMETRY_LOADED_EVENT,a),g()})}},g.destroy=function(){this.viewer=null,this.fakeRequest=null},g.setPathStorage=function(a){if(a){var b=a.length%4;b>0&&(a+="=".repeat(4-b)),this.PATH_STORAGE=a}},g.listComments=function(){var a=this;return new Promise(function(d,e){var f=[a.COMMENT_SERVICE_URL,"resources/",a.PATH_STORAGE].join(""),g=c(function(b){var c=JSON.parse(b);a.cache.comments=c,d(c)},e);b(a,"GET",f,"text/plain",g).send()})},g.postComment=function(a){var d=this;return new Promise(function(e,f){var g=[d.COMMENT_SERVICE_URL,"resources/",d.PATH_STORAGE].join(""),h=c(e,f);b(d,"POST",g,"text/plain",h).send(JSON.stringify(a))})},g.postCommentReply=function(a,d){var f=this;return new Promise(function(g,h){var i=window.encodeURIComponent(e(d)),j=[f.COMMENT_SERVICE_URL,"resources/",i].join(""),k=c(g,h);b(f,"POST",j,"text/plain",k).send(JSON.stringify(a))})},g.deleteComment=function(a){var d=this;return new Promise(function(f,g){var h=e(a),i=window.encodeURIComponent(h),j=[d.COMMENT_SERVICE_URL,"resources/",i].join(""),k=c(f,g);b(d,"DELETE",j,"text/plain",k).send()})},g.fetchLocationForNewOssAttachment=function(a,c){var e=[this.COMMENT_SERVICE_URL,"resources/",this.PATH_STORAGE,"/attachment"].join(""),f=b(this,"POST",e,"application/json",c,"fetchLocationForNewOssAttachment");d(f,a),f.send()},g.getAttachment=function(a,e,f){var g=this;return new Promise(function(h,i){var j=g.extractOssBucketAndId(a),k=[g.OBJECT_STORAGE_SERVICE_URL,"buckets/",j[0],"/objects/",j[1]].join(""),l=c(h,i,e),m=b(g,"GET",k,null,l);d(m,f),e&&(m.responseType="arraybuffer"),m.send()})},g.postAttachment=function(a,c,e,f,g){var h=[this.OBJECT_STORAGE_SERVICE_URL,"buckets/",e,"/objects/",a].join(""),i=b(this,"PUT",h,"text/plain",g);d(i,f),i.send(c)},g.deleteAttachment=function(a,c,d){b(this,"DELETE",[this.OBJECT_STORAGE_SERVICE_URL,"buckets/",c,"/objects/",a].join(""),"text/plain",d).send()},g.extractOssBucketAndId=function(a){var b=a.split("/"),c=b[0],d=c.split(":");return b[0]=d[d.length-1],b},g.getToken=function(){return this.token||Autodesk.Viewing.Private.token.accessToken},f.CommentService=a}(),function(){"use strict";function a(a,d){Autodesk.Viewing.Extension.call(this,a,d||{});var e,f;this.load=function(){var a=this.getCache();if(e=new c.CommentFactory(this.viewer),f=new c.CommentService(this.viewer,this.options,a),a.restoreComment){var b=a.restoreComment;delete a.restoreComment;var d=this,g=function(){var a=function(){d.isCommentForCurrentSheet(b)&&d.restoreComment(b)};d.viewer.getObjectTree(a,a)};this.viewer.model?g():this.viewer.addEventListener(av.GEOMETRY_LOADED_EVENT,function a(){d.viewer.removeEventListener(av.GEOMETRY_LOADED_EVENT,a),g()})}return!0},this.unload=function(){return f&&(f.destroy(),f=null),e&&(e.destroy(),e=null),!0},this.createComment=function(a){var b=a||{};"string"==typeof a&&(b={message:a});var c=e.createCommentObj(b);return e.exportCommentObj(c)},this.isCommentForCurrentSheet=function(a){return e.isCommentForCurrentSheet(a)},this.restoreComment=function(a,b,c){if(!this.isCommentForCurrentSheet(a)){var d=e.getManifestNode(a);if(d){return this.getCache().restoreComment=a,void this.viewer.dispatchEvent({type:Autodesk.Viewing.LOAD_GEOMETRY_EVENT,data:{item:d.data}})}}var f=this;e.importCommentObj(a).then(function(a){f.viewer.restoreState(a,b,c)})},this.setPathStorage=function(a){if(!a)throw new Error(b+": Invalid path storage");f.setPathStorage(a)},this.comments=function(){return this.getCache().comments||[]},this.getComments=function(){return f.listComments()},this.postComment=function(a){return f.postComment(a)},this.postCommentReply=function(a,b){return f.postCommentReply(a,b)},this.deleteComment=function(a){return f.deleteComment(a)}}var b="Autodesk.Viewing.Comments",c=AutodeskNamespace("Autodesk.Viewing.Extensions.Comments");a.prototype=Object.create(Autodesk.Viewing.Extension.prototype),a.prototype.constructor=a,Autodesk.Viewing.theExtensionManager.registerExtension(b,a),c.CommentsExtension=a}(),function(){"use strict";function a(a){this.options=a||{},this.FAKE_SERVER_DELAY=this.options.fakeSeverDelay||200,this.FAKE_NEXT_ID=11}var b=AutodeskNamespace("Autodesk.Viewing.Extensions.Comments");a.prototype.createRequest=function(a,b,c,d){var e=this;return{notifyCallback:function(a){e.FAKE_SERVER_DELAY?setTimeout(function(){c.onLoad(a)},e.FAKE_SERVER_DELAY):c.onLoad(a)},replyPostComment:function(a){var b=JSON.parse(a);b.id=e.FAKE_NEXT_ID++,b.index=b.id,b.layoutName=b.layoutName||"Another Sheet",b.actor||(b.actor={name:e.options.displayName||"John Doe",id:e.options.oxygenId||"ABCDEFGHIJK"}),b.published=(new Date).toUTCString(),this.notifyCallback({currentTarget:{status:200,responseText:JSON.stringify(b)}})},replyFetchLocationForNewOssAttachment:function(){var a={attachment:[{url:"urn:adsk.objects:os.object:comments/filename"}]};this.notifyCallback({currentTarget:{status:200,responseText:JSON.stringify(a)}})},send:function(b){switch(a){case"GET":this.notifyCallback({currentTarget:{status:200,responseText:"[]"}});break;case"POST":switch(d){case"fetchLocationForNewOssAttachment":this.replyFetchLocationForNewOssAttachment();break;default:this.replyPostComment(b)}break;case"DELETE":this.notifyCallback({currentTarget:{status:200,responseText:"{}"}});break;case"PUT":try{JSON.parse(b),this.notifyCallback({currentTarget:{status:200,responseText:b}})}catch(a){var c={objects:[{id:"test",key:"test","content-type":"image/png",location:"http://www.autodesk.com"}]};this.notifyCallback({currentTarget:{status:200,responseText:JSON.stringify(c)}})}}},setRequestHeader:function(){}}},b.FakeRequest=a}();